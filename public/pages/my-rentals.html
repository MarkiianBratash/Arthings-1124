<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="My rentals - Arthings">
    <title data-i18n="myRentals.pageTitle">My Rentals - Arthings</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="icon" type="image/png" href="/assets/images/logo.png">
</head>

<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-brand">
                <img src="/assets/images/logo.png" alt="Arthings" class="navbar-logo">
                <span class="navbar-title">Arthings</span>
            </a>
            <div class="navbar-nav">
                <a href="/" class="nav-link" data-i18n="nav.home">Home</a>
                <a href="/pages/map.html" class="nav-link" data-i18n="nav.map">Map</a>
                <a href="/pages/rental-requests.html" class="nav-link" data-i18n="nav.rentalRequests">Rental Requests</a>
                <a href="/pages/about.html" class="nav-link" data-i18n="nav.about">About</a>
                <a href="/pages/contact.html" class="nav-link" data-i18n="nav.contact">Contact</a>
            </div>
            <div class="navbar-actions">
                <div class="lang-switcher">
                    <button class="lang-btn active" data-lang="en">EN</button>
                    <button class="lang-btn" data-lang="uk">UK</button>
                </div>
                <div id="auth-links">
                    <a href="/pages/login.html" class="btn btn-ghost" data-i18n="nav.login">Log In</a>
                    <a href="/pages/register.html" class="btn btn-primary" data-i18n="nav.register">Sign Up</a>
                </div>
                <div id="user-links" class="hidden">
                    <a href="/pages/add-item.html" class="btn btn-primary" data-i18n="nav.addItem">Add Item</a>
                    <div class="user-dropdown">
                        <button class="btn btn-ghost user-menu-btn">
                            <span id="user-name">User</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </button>
                        <div class="dropdown-menu">
                            <a href="/pages/profile.html" data-i18n="nav.profile">Profile</a>
                            <a href="/pages/my-listings.html" data-i18n="nav.myListings">My Listings</a>
                            <a href="/pages/my-rentals.html" class="active" data-i18n="nav.myRentals">My Rentals</a>
                            <a href="/pages/favorites.html" data-i18n="nav.favorites">Favorites</a>
                            <a href="/pages/admin.html" class="admin-only hidden">⚙ Admin</a>
                            <hr>
                            <a href="#" class="logout-btn" data-i18n="nav.logout">Log Out</a>
                        </div>
                    </div>
                </div>
            </div>
            <button class="mobile-menu-btn" aria-label="Toggle menu"><span></span><span></span><span></span></button>
        </div>
    </nav>
    <div class="mobile-nav">
        <a href="/" class="mobile-nav-link" data-i18n="nav.home">Home</a>
        <a href="/pages/map.html" class="mobile-nav-link" data-i18n="nav.map">Map</a>
        <a href="/pages/rental-requests.html" class="mobile-nav-link" data-i18n="nav.rentalRequests">Rental Requests</a>
        <a href="/pages/about.html" class="mobile-nav-link" data-i18n="nav.about">About</a>
        <a href="/pages/contact.html" class="mobile-nav-link" data-i18n="nav.contact">Contact</a>
        <hr>
        <div id="mobile-auth-links">
            <a href="/pages/login.html" class="mobile-nav-link" data-i18n="nav.login">Log In</a>
            <a href="/pages/register.html" class="mobile-nav-link" data-i18n="nav.register">Sign Up</a>
        </div>
        <div id="mobile-user-links" class="hidden">
            <a href="/pages/add-item.html" class="mobile-nav-link" data-i18n="nav.addItem">Add Item</a>
            <a href="/pages/profile.html" class="mobile-nav-link" data-i18n="nav.profile">Profile</a>
            <a href="/pages/my-listings.html" class="mobile-nav-link" data-i18n="nav.myListings">My Listings</a>
            <a href="/pages/my-rentals.html" class="mobile-nav-link active" data-i18n="nav.myRentals">My Rentals</a>
            <a href="/pages/favorites.html" class="mobile-nav-link" data-i18n="nav.favorites">Favorites</a>
            <a href="#" class="mobile-nav-link logout-btn" data-i18n="nav.logout">Log Out</a>
        </div>
    </div>

    <div class="page-header">
        <div class="container">
            <h1 data-i18n="myRentals.title">My Rentals</h1>
        </div>
    </div>

    <section class="section" style="padding-top: 0;">
        <div class="container">
            <div class="dashboard-grid">
                <aside class="dashboard-sidebar">
                    <nav class="sidebar-nav">
                        <a href="/pages/profile.html" class="sidebar-link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                            <span data-i18n="nav.profile">Profile</span>
                        </a>
                        <a href="/pages/my-listings.html" class="sidebar-link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
                            <span data-i18n="nav.myListings">My Listings</span>
                        </a>
                        <a href="/pages/my-rentals.html" class="sidebar-link active">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
                            <span data-i18n="nav.myRentals">My Rentals</span>
                        </a>
                        <a href="/pages/favorites.html" class="sidebar-link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                            <span data-i18n="nav.favorites">Favorites</span>
                        </a>
                        <a href="/pages/add-item.html" class="sidebar-link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                            <span data-i18n="nav.addItem">Add Item</span>
                        </a>
                    </nav>
                </aside>
                <main class="dashboard-content">
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                        <button type="button" class="btn btn-ghost tab-btn active" data-role="renter" data-i18n="myRentals.asRenter">As renter</button>
                        <button type="button" class="btn btn-ghost tab-btn" data-role="owner" data-i18n="myRentals.asOwner">As owner</button>
                    </div>
                    <div id="rentals-content">
                        <div class="loading-spinner"></div>
                    </div>
                </main>
            </div>
        </div>
    </section>

    <!-- Rating modal -->
    <div id="rating-modal-backdrop" class="modal-backdrop" style="display: none;">
        <div id="rating-modal" class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 id="rating-modal-title">Rate</h3>
                <button type="button" class="modal-close" id="rating-modal-close">&times;</button>
            </div>
            <form id="rating-form">
                <input type="hidden" id="rating-rental-id">
                <input type="hidden" id="rating-to-user-id">
                <div class="form-group">
                    <label class="form-label" data-i18n="rating.score">Score (1–5)</label>
                    <div id="rating-stars" style="display: flex; gap: 0.5rem; font-size: 1.5rem;">
                        <button type="button" class="rating-star" data-score="1">★</button>
                        <button type="button" class="rating-star" data-score="2">★</button>
                        <button type="button" class="rating-star" data-score="3">★</button>
                        <button type="button" class="rating-star" data-score="4">★</button>
                        <button type="button" class="rating-star" data-score="5">★</button>
                    </div>
                    <input type="hidden" id="rating-score" value="5">
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="rating.comment">Comment (optional)</label>
                    <textarea id="rating-comment" class="form-input form-textarea" rows="3" maxlength="1000"></textarea>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="btn btn-ghost" id="rating-cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" data-i18n="rating.submit">Submit rating</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <script src="/components/legal-modal.js"></script>
    <script src="/components/cookie-banner.js"></script>
    <script src="/assets/js/i18n.js"></script>
    <script src="/assets/js/main.js"></script>
    <script>
        let currentRole = 'renter';
        let rentalsData = { renter: [], owner: [] };

        document.addEventListener('DOMContentLoaded', async () => {
            const user = await checkAuth();
            if (!user) {
                window.location.href = '/pages/login.html?return=' + encodeURIComponent('/pages/my-rentals.html');
                return;
            }
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentRole = btn.dataset.role;
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    loadRentals();
                });
            });
            document.getElementById('rating-modal-close').addEventListener('click', closeRatingModal);
            document.getElementById('rating-cancel').addEventListener('click', closeRatingModal);
            document.getElementById('rating-modal-backdrop').addEventListener('click', (e) => { if (e.target.id === 'rating-modal-backdrop') closeRatingModal(); });
            document.getElementById('rating-form').addEventListener('submit', submitRating);
            document.querySelectorAll('.rating-star').forEach(btn => {
                btn.addEventListener('click', () => {
                    const score = parseInt(btn.dataset.score, 10);
                    document.getElementById('rating-score').value = score;
                    document.querySelectorAll('.rating-star').forEach(s => {
                        s.style.color = parseInt(s.dataset.score, 10) <= score ? 'var(--color-warning)' : 'var(--color-gray-300)';
                    });
                });
            });
            loadRentals();
        });

        async function loadRentals() {
            const content = document.getElementById('rentals-content');
            content.innerHTML = '<div class="loading-spinner"></div>';
            try {
                const data = await api.get('/api/rentals?role=' + currentRole);
                rentalsData[currentRole] = data.rentals || [];
                const canRateMap = {};
                for (const r of rentalsData[currentRole].filter(x => x.status === 'completed')) {
                    try {
                        const cr = await api.get('/api/ratings/rental/' + r.id + '/can-rate');
                        canRateMap[r.id] = cr;
                    } catch (e) {
                        canRateMap[r.id] = {};
                    }
                }
                renderRentals(rentalsData[currentRole], canRateMap);
            } catch (err) {
                content.innerHTML = '<p class="empty-state">' + (err.message || 'Failed to load rentals') + '</p>';
            }
        }

        function renderRentals(rentals, canRateMap) {
            const content = document.getElementById('rentals-content');
            if (!rentals.length) {
                content.innerHTML = '<div class="empty-state"><p data-i18n="myRentals.empty">No rentals here yet.</p></div>';
                return;
            }
            const statusLabel = (s) => ({ pending: 'Pending', approved: 'Approved', declined: 'Declined', completed: 'Completed', cancelled: 'Cancelled' }[s] || s);
            content.innerHTML = rentals.map(r => {
                const canRate = canRateMap[r.id] || {};
                const product = r.product || {};
                let rateBtns = '';
                if (r.status === 'completed') {
                    if (canRate.canRateOwner) rateBtns += '<button type="button" class="btn btn-ghost btn-sm rate-btn" data-rental-id="' + r.id + '" data-to-user-id="' + (canRate.ownerId || '') + '" data-label="' + escapeHtml(canRate.ownerName || 'Owner') + '">Rate owner</button>';
                    if (canRate.canRateRenter) rateBtns += '<button type="button" class="btn btn-ghost btn-sm rate-btn" data-rental-id="' + r.id + '" data-to-user-id="' + (canRate.renterId || '') + '" data-label="' + escapeHtml(canRate.renterName || 'Renter') + '">Rate renter</button>';
                    if (!rateBtns && (canRate.alreadyRatedOwner || canRate.alreadyRatedRenter)) rateBtns = '<span style="color:var(--color-success);font-size:0.875rem;">✓ Rated</span>';
                }
                return `
                    <div class="card" style="padding: 1.25rem; margin-bottom: 1rem;">
                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 1rem;">
                            <div>${product.image ? '<img src="' + product.image + '" alt="" style="width:100%;height:100px;object-fit:cover;border-radius:8px;">' : '<div style="height:100px;background:var(--color-gray-200);border-radius:8px;"></div>'}</div>
                            <div>
                                <h3 style="margin-bottom: 0.25rem;">${escapeHtml(product.title || 'Item')}</h3>
                                <p style="font-size: 0.875rem; color: var(--color-gray-600);">${r.startDate} – ${r.endDate} · ${r.days} days · ${statusLabel(r.status)}</p>
                                <p style="font-size: 0.875rem;">${currentRole === 'owner' ? escapeHtml(r.renterName || 'Renter') : escapeHtml(r.ownerName || 'Owner')}</p>
                                <p style="font-weight: 600;">${Number(r.totalPrice).toFixed(0)} ₴</p>
                                <div style="margin-top: 0.75rem;">${rateBtns}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            content.querySelectorAll('.rate-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const rentalId = btn.dataset.rentalId;
                    const toUserId = btn.dataset.toUserId;
                    const label = btn.dataset.label || 'User';
                    document.getElementById('rating-rental-id').value = rentalId;
                    document.getElementById('rating-to-user-id').value = toUserId;
                    document.getElementById('rating-modal-title').textContent = (typeof i18n !== 'undefined' && i18n.t('rating.rateUser') ? i18n.t('rating.rateUser') : 'Rate') + ' ' + label;
                    document.getElementById('rating-score').value = '5';
                    document.getElementById('rating-comment').value = '';
                    document.querySelectorAll('.rating-star').forEach(s => {
                        s.style.color = 'var(--color-warning)';
                    });
                    document.getElementById('rating-modal-backdrop').style.display = 'flex';
                });
            });
        }

        function escapeHtml(s) {
            if (!s) return '';
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        function closeRatingModal() {
            document.getElementById('rating-modal-backdrop').style.display = 'none';
        }

        async function submitRating(e) {
            e.preventDefault();
            const rentalId = document.getElementById('rating-rental-id').value;
            const toUserId = document.getElementById('rating-to-user-id').value;
            const score = document.getElementById('rating-score').value;
            const comment = document.getElementById('rating-comment').value.trim();
            try {
                await api.post('/api/ratings', { rentalId, toUserId, score, comment: comment || undefined });
                showToast('success', typeof i18n !== 'undefined' && i18n.t('rating.success') ? i18n.t('rating.success') : 'Rating submitted');
                closeRatingModal();
                loadRentals();
            } catch (err) {
                showToast('error', err.message || 'Failed to submit rating');
            }
        }
    </script>
</body>

</html>
