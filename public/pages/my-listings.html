<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Manage your listed items on Arthings">
    <title>My Listings - Arthings</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="icon" type="image/png" href="/assets/images/logo.png">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-brand">
                <img src="/assets/images/logo.png" alt="Arthings" class="navbar-logo">
                <span class="navbar-title">Arthings</span>
            </a>

            <div class="navbar-nav">
                <a href="/" class="nav-link" data-i18n="nav.home">Home</a>
                <a href="/pages/map.html" class="nav-link" data-i18n="nav.map">Map</a>
                <a href="/pages/rental-requests.html" class="nav-link" data-i18n="nav.rentalRequests">Rental Requests</a>
                <a href="/pages/about.html" class="nav-link" data-i18n="nav.about">About</a>
                <a href="/pages/contact.html" class="nav-link" data-i18n="nav.contact">Contact</a>
            </div>

            <div class="navbar-actions">
                <div class="lang-switcher">
                    <button class="lang-btn active" data-lang="en">EN</button>
                    <button class="lang-btn" data-lang="uk">UK</button>
                </div>

                <!-- Auth Links (when logged out) -->
                <div id="auth-links">
                    <a href="/pages/login.html" class="btn btn-ghost" data-i18n="nav.login">Log In</a>
                    <a href="/pages/register.html" class="btn btn-primary" data-i18n="nav.register">Sign Up</a>
                </div>

                <!-- User Links (when logged in) -->
                <div id="user-links" class="hidden">
                    <a href="/pages/add-item.html" class="btn btn-primary" data-i18n="nav.addItem">Add Item</a>
                    <div class="user-dropdown">
                        <button class="btn btn-ghost user-menu-btn">
                            <span id="user-name">User</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                        <div class="dropdown-menu">
                            <a href="/pages/profile.html" data-i18n="nav.profile">Profile</a>
                            <a href="/pages/my-listings.html" data-i18n="nav.myListings">My Listings</a>
                            <a href="/pages/my-rentals.html" data-i18n="nav.myRentals">My Rentals</a>
                            <a href="/pages/favorites.html" data-i18n="nav.favorites">Favorites</a>
                            <hr>
                            <a href="#" class="logout-btn" data-i18n="nav.logout">Log Out</a>
                        </div>
                    </div>
                </div>
            </div>

            <button class="mobile-menu-btn" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <!-- Mobile Navigation -->
    <div class="mobile-nav">
        <a href="/" class="mobile-nav-link" data-i18n="nav.home">Home</a>
        <a href="/pages/map.html" class="mobile-nav-link" data-i18n="nav.map">Map</a>
        <a href="/pages/about.html" class="mobile-nav-link" data-i18n="nav.about">About</a>
        <a href="/pages/contact.html" class="mobile-nav-link" data-i18n="nav.contact">Contact</a>
        <hr>
        <div id="mobile-auth-links">
            <a href="/pages/login.html" class="mobile-nav-link" data-i18n="nav.login">Log In</a>
            <a href="/pages/register.html" class="mobile-nav-link" data-i18n="nav.register">Sign Up</a>
        </div>
        <div id="mobile-user-links" class="hidden">
            <a href="/pages/add-item.html" class="mobile-nav-link" data-i18n="nav.addItem">Add Item</a>
            <a href="/pages/profile.html" class="mobile-nav-link" data-i18n="nav.profile">Profile</a>
            <a href="/pages/my-listings.html" class="mobile-nav-link" data-i18n="nav.myListings">My Listings</a>
            <a href="/pages/my-rentals.html" class="mobile-nav-link" data-i18n="nav.myRentals">My Rentals</a>
            <a href="/pages/favorites.html" class="mobile-nav-link" data-i18n="nav.favorites">Favorites</a>
            <a href="#" class="mobile-nav-link logout-btn" data-i18n="nav.logout">Log Out</a>
        </div>
    </div>

    <!-- Page Header -->
    <div class="page-header">
        <div class="container">
            <h1 data-i18n="listings.title">My Listings</h1>
        </div>
    </div>

    <!-- Dashboard -->
    <section class="section" style="padding-top: 0;">
        <div class="container">
            <div class="dashboard-grid">
                <!-- Sidebar -->
                <aside class="dashboard-sidebar">
                    <nav class="sidebar-nav">
                        <a href="/pages/profile.html" class="sidebar-link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            <span data-i18n="nav.profile">Profile</span>
                        </a>
                        <a href="/pages/my-listings.html" class="sidebar-link active">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="3" y1="9" x2="21" y2="9"></line>
                                <line x1="9" y1="21" x2="9" y2="9"></line>
                            </svg>
                            <span data-i18n="nav.myListings">My Listings</span>
                        </a>
                        <a href="/pages/my-rentals.html" class="sidebar-link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
                            <span data-i18n="nav.myRentals">My Rentals</span>
                        </a>
                        <a href="/pages/favorites.html" class="sidebar-link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path
                                    d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z">
                                </path>
                            </svg>
                            <span data-i18n="nav.favorites">Favorites</span>
                        </a>
                        <a href="/pages/add-item.html" class="sidebar-link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="16"></line>
                                <line x1="8" y1="12" x2="16" y2="12"></line>
                            </svg>
                            <span data-i18n="nav.addItem">Add Item</span>
                        </a>
                    </nav>
                </aside>

                <!-- Content -->
                <main class="dashboard-content">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 id="listings-count"></h3>
                        <a href="/pages/add-item.html" class="btn btn-primary" data-i18n="nav.addItem">Add Item</a>
                    </div>

                    <div id="listings-grid" class="product-grid">
                        <div class="loading-spinner" style="grid-column: 1 / -1; justify-self: center;"></div>
                    </div>
                </main>
            </div>
        </div>
    </section>

    <!-- Edit Modal -->
    <div id="edit-modal-backdrop" class="modal-backdrop">
        <div id="edit-modal" class="modal">
            <div class="modal-header">
                <h3>Edit Item</h3>
                <button class="modal-close" onclick="closeEditModal()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <form id="edit-form">
                <input type="hidden" id="edit-id">
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" id="edit-title" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="edit-description" class="form-input form-textarea" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Price per Day (₴)</label>
                    <input type="number" id="edit-price" class="form-input" min="1" required>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="edit-available">
                        <span>Available for rent</span>
                    </label>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="btn btn-ghost" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="delete-modal-backdrop" class="modal-backdrop">
        <div id="delete-modal" class="modal" style="max-width: 400px;">
            <div class="modal-header" style="border-bottom: none; padding-bottom: 0;">
                <div
                    style="width: 60px; height: 60px; background: rgba(239, 68, 68, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                        <path d="M3 6h18"></path>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                </div>
                <h3 style="text-align: center; margin-bottom: 0.5rem;">Delete Listing?</h3>
            </div>
            <div style="text-align: center; padding: 0 1.5rem 1.5rem;">
                <p style="color: var(--color-gray-600); margin-bottom: 1.5rem;">
                    Are you sure you want to delete this listing? This action cannot be undone.
                </p>
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button type="button" class="btn btn-ghost" onclick="closeDeleteModal()">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete Listing</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <script src="/components/legal-modal.js"></script>
    <script src="/components/cookie-banner.js"></script>
    <script src="/assets/js/i18n.js"></script>
    <script src="/assets/js/main.js"></script>
    <script>
        let myListings = [];
        let itemToDeleteId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const user = await checkAuth();
            if (!user) {
                window.location.href = '/pages/login.html?return=/pages/my-listings.html';
                return;
            }

            await loadListings();
            setupEditForm();
            setupDeleteModal();
        });

        async function loadListings() {
            try {
                const data = await api.get(`/api/products?userId=${currentUser.id}`);
                myListings = data.products || [];
                renderListings();
            } catch (error) {
                showToast('error', error.message);
            }
        }

        function renderListings() {
            const grid = document.getElementById('listings-grid');
            const count = document.getElementById('listings-count');

            if (myListings.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="12" y1="8" x2="12" y2="16"></line>
                                <line x1="8" y1="12" x2="16" y2="12"></line>
                            </svg>
                        </div>
                        <h3 data-i18n="listings.empty">You haven't listed any items yet</h3>
                        <a href="/pages/add-item.html" class="btn btn-primary mt-4" data-i18n="listings.addFirst">List your first item</a>
                    </div>
                `;
                count.textContent = '';
                return;
            }

            count.textContent = `${myListings.length} ${myListings.length === 1 ? 'listing' : 'listings'}`;
            grid.innerHTML = '';

            myListings.forEach(product => {
                const card = createListingCard(product);
                grid.appendChild(card);
            });
        }

        function createListingCard(product) {
            const card = document.createElement('article');
            card.className = 'card';

            const imageUrl = product.images && product.images.length > 0
                ? product.images[0]
                : '/assets/images/placeholder.png';

            card.innerHTML = `
                <div class="card-image">
                    <img src="${imageUrl}" alt="${escapeHtml(product.title)}" loading="lazy">
                    <span class="card-badge" style="${!product.available ? 'background: var(--color-gray-600);' : ''}">${product.available ? 'Available' : 'Unavailable'}</span>
                </div>
                <div class="card-body">
                    <h3 class="card-title">${escapeHtml(product.title)}</h3>
                    <div class="card-location">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        <span>${escapeHtml(product.city || 'Unknown')}</span>
                    </div>
                    <div class="card-footer">
                        <div class="card-price">₴${product.price} <span>/ day</span></div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm btn-ghost" onclick="openEditModal('${product.id}')">Edit</button>
                            <button class="btn btn-sm btn-ghost" style="color: var(--color-error);" onclick="confirmDeleteItem('${product.id}')">Delete</button>
                        </div>
                    </div>
                </div>
            `;

            return card;
        }

        function openEditModal(productId) {
            const product = myListings.find(p => p.id === productId);
            if (!product) return;

            document.getElementById('edit-id').value = product.id;
            document.getElementById('edit-title').value = product.title;
            document.getElementById('edit-description').value = product.description;
            document.getElementById('edit-price').value = product.price;
            document.getElementById('edit-available').checked = product.available;

            document.getElementById('edit-modal-backdrop').classList.add('active');
            document.getElementById('edit-modal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-modal-backdrop').classList.remove('active');
            document.getElementById('edit-modal').classList.remove('active');
        }

        function setupEditForm() {
            document.getElementById('edit-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const productId = document.getElementById('edit-id').value;
                const title = document.getElementById('edit-title').value.trim();
                const description = document.getElementById('edit-description').value.trim();
                const price = document.getElementById('edit-price').value;
                const available = document.getElementById('edit-available').checked;

                try {
                    await api.put(`/api/products/${productId}`, {
                        title,
                        description,
                        price,
                        available
                    });

                    showToast('success', i18n.t('toast.itemUpdated'));
                    closeEditModal();
                    await loadListings();

                } catch (error) {
                    showToast('error', error.message);
                }
            });

            // Close modal on backdrop click
            document.getElementById('edit-modal-backdrop').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    closeEditModal();
                }
            });
        }

        // Delete Modal Functions
        window.confirmDeleteItem = function (productId) {
            console.log('Confirm delete item:', productId);
            itemToDeleteId = productId;
            document.getElementById('delete-modal-backdrop').classList.add('active');
            document.getElementById('delete-modal').classList.add('active');
        };

        window.closeDeleteModal = function () {
            itemToDeleteId = null;
            document.getElementById('delete-modal-backdrop').classList.remove('active');
            document.getElementById('delete-modal').classList.remove('active');
        };

        function setupDeleteModal() {
            const confirmBtn = document.getElementById('confirm-delete-btn');

            confirmBtn.addEventListener('click', async () => {
                if (!itemToDeleteId) return;

                // Disable button to prevent double clicks
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Deleting...';

                try {
                    await api.delete(`/api/products/${itemToDeleteId}`);
                    showToast('success', i18n.t('toast.itemDeleted'));
                    await loadListings();
                    window.closeDeleteModal();
                } catch (error) {
                    console.error('Delete error:', error);
                    showToast('error', error.message);
                } finally {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'Delete Listing';
                }
            });

            // Close on backdrop click
            document.getElementById('delete-modal-backdrop').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    window.closeDeleteModal();
                }
            });
        }
    </script>

    <style>
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .checkbox-label input {
            width: 18px;
            height: 18px;
            accent-color: var(--color-primary);
        }
    </style>
</body>

</html>